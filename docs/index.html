<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Japan 225 Bot</title>
  <script src="https://cdn.jsdelivr.net/npm/marked@9/marked.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #05090f;
      --bg-subtle: #080d17;
      --surface: #0a1120;
      --surface-hover: #0d1528;
      --card: #0e1726;
      --card-hover: #131d30;
      --card-elevated: #111c2e;
      --border: #172033;
      --border-bright: #243652;
      --border-glow: rgba(59,130,246,.15);
      --primary: #4f8ff7;
      --primary-hover: #3a7be8;
      --primary-dim: rgba(79,143,247,.08);
      --primary-glow: rgba(79,143,247,.12);
      --long: #22c997;
      --long-dim: rgba(34,201,151,.08);
      --short: #f04444;
      --short-dim: rgba(240,68,68,.08);
      --warning: #f5a623;
      --warning-dim: rgba(245,166,35,.08);
      --text: #e8edf5;
      --text-secondary: #b0bdd0;
      --text-dim: #8798b2;
      --text-muted: #4a5f80;
      --radius: 10px;
      --radius-sm: 6px;
      --radius-lg: 14px;
      --shadow-sm: 0 1px 3px rgba(0,0,0,.3), 0 1px 2px rgba(0,0,0,.2);
      --shadow-md: 0 4px 12px rgba(0,0,0,.35), 0 2px 4px rgba(0,0,0,.25);
      --shadow-lg: 0 8px 24px rgba(0,0,0,.4), 0 4px 8px rgba(0,0,0,.3);
      --font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      --font-mono: 'JetBrains Mono', 'SF Mono', 'Fira Code', 'Consolas', monospace;
      --transition: .2s cubic-bezier(.4,0,.2,1);
    }

    html, body { height: 100%; background: var(--bg); color: var(--text); font-family: var(--font); font-size: 14px; line-height: 1.6; overflow: hidden; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

    /* â”€â”€ Layout â”€â”€ */
    #app { display: flex; flex-direction: column; height: 100vh; }

    /* â”€â”€ Header â”€â”€ */
    #header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 24px; background: linear-gradient(180deg, var(--surface) 0%, var(--bg-subtle) 100%);
      border-bottom: 1px solid var(--border); flex-shrink: 0;
      box-shadow: 0 1px 8px rgba(0,0,0,.25);
    }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .logo { font-size: 16px; font-weight: 800; letter-spacing: -0.5px; }
    .logo span { color: var(--primary); }
    .status-pill {
      display: flex; align-items: center; gap: 7px;
      padding: 4px 12px; border-radius: 20px;
      background: var(--bg); border: 1px solid var(--border);
      font-size: 12px; color: var(--text-dim); font-weight: 500;
      transition: border-color var(--transition);
    }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-muted); flex-shrink: 0; transition: all var(--transition); }
    .status-dot.ok { background: var(--long); box-shadow: 0 0 8px rgba(34,201,151,.5), 0 0 16px rgba(34,201,151,.2); animation: pulse 2.5s ease-in-out infinite; }
    .status-dot.err { background: var(--short); box-shadow: 0 0 8px rgba(240,68,68,.4); }
    @keyframes pulse { 0%,100%{opacity:1; transform:scale(1)} 50%{opacity:.5; transform:scale(.85)} }
    .header-right { display: flex; align-items: center; gap: 10px; }
    .last-update { font-size: 11px; color: var(--text-muted); font-weight: 500; }

    /* â”€â”€ Tabs â”€â”€ */
    #tabs {
      display: flex; gap: 0; padding: 0 20px;
      background: var(--surface); border-bottom: 1px solid var(--border);
      flex-shrink: 0; overflow-x: auto;
    }
    #tabs::-webkit-scrollbar { display: none; }
    .tab {
      padding: 12px 20px; background: none; border: none;
      border-bottom: 2px solid transparent; color: var(--text-muted);
      cursor: pointer; font-size: 13px; font-weight: 600; letter-spacing: .2px;
      white-space: nowrap; transition: color var(--transition), border-color var(--transition), background var(--transition);
      position: relative;
    }
    .tab:hover { color: var(--text-dim); background: rgba(255,255,255,.02); }
    .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    .tab.active::after { content: ''; position: absolute; bottom: -1px; left: 20%; right: 20%; height: 2px; background: var(--primary); filter: blur(4px); opacity: .5; }

    /* â”€â”€ Content â”€â”€ */
    #content { flex: 1; overflow-y: auto; padding: 20px 24px; scroll-behavior: smooth; }
    .tab-panel { display: none; animation: fadeIn .25s ease; }
    .tab-panel.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: none; } }

    /* â”€â”€ Grid â”€â”€ */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
    @media(max-width:900px) { .grid-2,.grid-3 { grid-template-columns: 1fr; } }

    /* â”€â”€ Cards â”€â”€ */
    .card {
      background: linear-gradient(180deg, var(--card) 0%, var(--bg-subtle) 100%);
      border: 1px solid var(--border); border-radius: var(--radius-lg);
      padding: 20px; box-shadow: var(--shadow-sm);
      transition: border-color var(--transition), box-shadow var(--transition);
    }
    .card:hover { border-color: var(--border-bright); }
    .card-title {
      font-size: 11px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 1.2px; color: var(--text-muted); margin-bottom: 16px;
      display: flex; align-items: center; gap: 8px;
    }
    .card-title::before {
      content: ''; display: inline-block; width: 3px; height: 12px;
      background: var(--primary); border-radius: 2px; flex-shrink: 0;
    }

    /* â”€â”€ Stat rows â”€â”€ */
    .stat-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 9px 4px; border-bottom: 1px solid rgba(23,32,51,.7);
      transition: background var(--transition);
    }
    .stat-row:hover { background: rgba(255,255,255,.015); border-radius: 4px; }
    .stat-row:last-child { border-bottom: none; }
    .stat-label { font-size: 12px; color: var(--text-dim); font-weight: 500; }
    .stat-value { font-size: 13px; font-weight: 600; letter-spacing: -.2px; }

    /* â”€â”€ Badges â”€â”€ */
    .badge {
      display: inline-flex; align-items: center; padding: 3px 9px; border-radius: 5px;
      font-size: 11px; font-weight: 700; letter-spacing: .3px;
      border: 1px solid transparent;
    }
    .b-long   { background: rgba(34,201,151,.1); color: var(--long); border-color: rgba(34,201,151,.2); }
    .b-short  { background: rgba(240,68,68,.1);  color: var(--short); border-color: rgba(240,68,68,.2); }
    .b-neutral{ background: rgba(148,163,184,.07); color: var(--text-dim); border-color: rgba(148,163,184,.12); }
    .b-warn   { background: rgba(245,166,35,.1); color: var(--warning); border-color: rgba(245,166,35,.2); }
    .b-blue   { background: rgba(79,143,247,.1); color: var(--primary); border-color: rgba(79,143,247,.2); }

    /* â”€â”€ PnL â”€â”€ */
    .pnl-big { font-size: 34px; font-weight: 800; line-height: 1; letter-spacing: -1px; font-variant-numeric: tabular-nums; }
    .c-long { color: var(--long); }
    .c-short { color: var(--short); }
    .c-dim { color: var(--text-dim); }
    .c-warn { color: var(--warning); }

    /* â”€â”€ No-position â”€â”€ */
    #posCard { display:flex; flex-direction:column; }
    #posPanel { flex:1; display:flex; flex-direction:column; }
    .no-pos {
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      flex:1; min-height:140px; padding:24px; color:var(--text-muted); gap:10px; text-align:center; width:100%;
      background: radial-gradient(ellipse at center, rgba(79,143,247,.03) 0%, transparent 70%);
      border-radius: var(--radius);
    }
    .no-pos svg { opacity:.25; }
    .no-pos span { font-size:13px; font-weight:500; }

    /* â”€â”€ Phase bar â”€â”€ */
    .phase-bar { margin-top: 16px; padding-top: 14px; border-top: 1px solid var(--border); }
    .phase-lbl { font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:.6px; margin-bottom:8px; font-weight:600; }
    .phase-steps { display:flex; gap:5px; }
    .phase-step { flex:1; height:4px; border-radius:3px; background:var(--border); transition: background var(--transition); }
    .phase-step.done { background: linear-gradient(90deg, var(--long), #30dfaa); box-shadow: 0 0 6px rgba(34,201,151,.25); }
    .phase-step.active { background: linear-gradient(90deg, var(--primary), #6ba5f9); box-shadow: 0 0 6px rgba(79,143,247,.25); }

    /* â”€â”€ Table â”€â”€ */
    .tbl-wrap { overflow-x: auto; border-radius: var(--radius); }
    table { width:100%; border-collapse:collapse; font-size:13px; }
    th {
      text-align:left; padding:10px 14px; color:var(--text-muted); font-size:10px; font-weight:700;
      text-transform:uppercase; letter-spacing:.7px; border-bottom:2px solid var(--border); white-space:nowrap;
      background: rgba(0,0,0,.15);
    }
    th.sortable { cursor:pointer; user-select:none; transition: color var(--transition); }
    th.sortable:hover { color:var(--text-secondary); }
    th.sortable.sort-active { color:var(--primary); }
    .sort-icon { margin-left:4px; opacity:.5; font-style:normal; }
    th.sort-active .sort-icon { opacity:1; }
    td { padding:10px 14px; border-bottom:1px solid rgba(23,32,51,.6); color:var(--text-dim); transition: background var(--transition); font-variant-numeric: tabular-nums; }
    tr:last-child td { border-bottom:none; }
    tr:hover td { background:rgba(79,143,247,.03); }
    tbody tr:nth-child(even) td { background: rgba(0,0,0,.08); }
    tbody tr:nth-child(even):hover td { background: rgba(79,143,247,.04); }

    /* â”€â”€ Buttons â”€â”€ */
    .btn {
      display:inline-flex; align-items:center; gap:6px;
      padding:8px 16px; border:none; border-radius:var(--radius);
      font-size:13px; font-weight:600; cursor:pointer; transition:all var(--transition); white-space:nowrap;
      letter-spacing: .1px;
    }
    .btn:disabled { opacity:.4; cursor:not-allowed; }
    .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, #3a7be8 100%); color:#fff; box-shadow: 0 2px 8px rgba(79,143,247,.25); }
    .btn-primary:hover:not(:disabled) { background: linear-gradient(135deg, #3a7be8 0%, #2b6ad6 100%); box-shadow: 0 4px 12px rgba(79,143,247,.35); transform: translateY(-1px); }
    .btn-primary:active:not(:disabled) { transform: translateY(0); }
    .btn-ghost { background:rgba(23,32,51,.8); color:var(--text-dim); border: 1px solid var(--border); }
    .btn-ghost:hover:not(:disabled) { background:var(--border-bright); color:var(--text); border-color: var(--border-bright); }
    .btn-danger { background:rgba(240,68,68,.08); color:var(--short); border:1px solid rgba(240,68,68,.2); }
    .btn-danger:hover:not(:disabled) { background:rgba(240,68,68,.15); border-color:rgba(240,68,68,.35); transform: translateY(-1px); }
    .btn-warn { background:rgba(245,166,35,.08); color:var(--warning); border:1px solid rgba(245,166,35,.2); }
    .btn-warn:hover:not(:disabled) { background:rgba(245,166,35,.15); border-color:rgba(245,166,35,.35); transform: translateY(-1px); }
    .btn-success { background:rgba(34,201,151,.08); color:var(--long); border:1px solid rgba(34,201,151,.2); }
    .btn-success:hover:not(:disabled) { background:rgba(34,201,151,.15); border-color:rgba(34,201,151,.35); transform: translateY(-1px); }
    .btn:active:not(:disabled) { transform: translateY(0); }
    .btn-sm { padding:5px 11px; font-size:12px; border-radius: var(--radius-sm); }
    .icon-btn {
      width:32px; height:32px; padding:0; border-radius:var(--radius-sm);
      display:inline-flex; align-items:center; justify-content:center;
      background:rgba(23,32,51,.5); border:1px solid var(--border); color:var(--text-dim);
      cursor:pointer; transition:all var(--transition);
    }
    .icon-btn:hover { background:var(--border); color:var(--text); border-color:var(--border-bright); transform: translateY(-1px); }

    /* â”€â”€ Forms â”€â”€ */
    .form-group { margin-bottom:16px; }
    .form-label { display:block; font-size:11px; font-weight:700; color:var(--text-dim); margin-bottom:6px; text-transform:uppercase; letter-spacing:.5px; }
    .form-input {
      width:100%; padding:10px 12px;
      background:var(--bg); border:1px solid var(--border); border-radius:var(--radius-sm);
      color:var(--text); font-size:13px; outline:none; transition:all var(--transition);
      box-shadow: inset 0 1px 3px rgba(0,0,0,.15);
    }
    .form-input:focus { border-color:var(--primary); box-shadow: inset 0 1px 3px rgba(0,0,0,.15), 0 0 0 3px rgba(79,143,247,.1); }
    .form-hint { font-size:11px; color:var(--text-muted); margin-top:4px; }

    /* â”€â”€ Range â”€â”€ */
    .range-row { display:flex; align-items:center; gap:12px; }
    input[type=range] {
      flex:1; -webkit-appearance:none; height:4px;
      background: linear-gradient(90deg, var(--border) 0%, var(--border-bright) 100%);
      border-radius:3px; outline:none; transition: background var(--transition);
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance:none; width:16px; height:16px; border-radius:50%;
      background: linear-gradient(135deg, var(--primary) 0%, #3a7be8 100%);
      cursor:pointer; box-shadow: 0 2px 6px rgba(79,143,247,.3);
      transition: box-shadow var(--transition), transform var(--transition);
    }
    input[type=range]::-webkit-slider-thumb:hover { box-shadow: 0 2px 10px rgba(79,143,247,.5); transform: scale(1.15); }
    input[type=range]::-moz-range-thumb {
      width:16px; height:16px; border-radius:50%; border:none;
      background: linear-gradient(135deg, var(--primary) 0%, #3a7be8 100%);
      cursor:pointer; box-shadow: 0 2px 6px rgba(79,143,247,.3);
    }
    .range-val {
      min-width:40px; text-align:center; font-size:13px; font-weight:700; color:var(--text);
      background: var(--bg); border: 1px solid var(--border); border-radius: 4px; padding: 2px 6px;
      font-variant-numeric: tabular-nums;
    }

    /* â”€â”€ Toggle â”€â”€ */
    .toggle-row { display:flex; align-items:center; justify-content:space-between; padding:12px 4px; border-bottom:1px solid rgba(23,32,51,.7); transition: background var(--transition); }
    .toggle-row:hover { background: rgba(255,255,255,.01); }
    .toggle-row:last-child { border-bottom:none; }
    .toggle-info .t-name { font-size:13px; font-weight:600; }
    .toggle-info .t-desc { font-size:11px; color:var(--text-muted); margin-top:2px; }
    .toggle { position:relative; width:38px; height:21px; flex-shrink:0; cursor:pointer; }
    .toggle input { opacity:0; width:0; height:0; }
    .tgl-slider { position:absolute; inset:0; background:var(--border); border-radius:20px; transition: all .25s cubic-bezier(.4,0,.2,1); }
    .tgl-slider::before { content:''; position:absolute; width:15px; height:15px; left:3px; bottom:3px; background:#fff; border-radius:50%; transition: all .25s cubic-bezier(.4,0,.2,1); box-shadow: 0 1px 3px rgba(0,0,0,.3); }
    .toggle input:checked + .tgl-slider { background: linear-gradient(135deg, var(--primary), #3a7be8); box-shadow: 0 0 8px rgba(79,143,247,.25); }
    .toggle input:checked + .tgl-slider::before { transform:translateX(17px); }

    /* â”€â”€ Log box â”€â”€ */
    .log-box {
      background:var(--bg); border:1px solid var(--border); border-radius:var(--radius);
      padding:14px 16px; height:340px; overflow-y:auto;
      font-family:var(--font-mono); font-size:12px; line-height:1.8; color:var(--text-dim);
    }
    .log-box > div { padding: 1px 0; border-bottom: 1px solid rgba(23,32,51,.4); }
    .log-box > div:last-child { border-bottom: none; }
    .l-info  { color:var(--text-muted); }
    .l-warn  { color:var(--warning); }
    .l-err   { color:var(--short); font-weight:500; }
    .l-trade { color:var(--long); font-weight:600; }

    /* â”€â”€ Chat â”€â”€ */
    .chat-box { height:440px; overflow-y:auto; padding:18px 4px; display:flex; flex-direction:column; gap:2px; scroll-behavior:smooth; }
    .chat-row { display:flex; gap:12px; padding:6px 0; align-items:flex-start; }
    .chat-row.user { flex-direction:row-reverse; }
    .chat-avatar {
      width:32px; height:32px; border-radius:50%; flex-shrink:0;
      display:flex; align-items:center; justify-content:center;
      font-size:14px; font-weight:700; margin-top:2px;
      box-shadow: var(--shadow-sm);
    }
    .chat-avatar.claude { background:linear-gradient(135deg,#c96a1e 0%,#d98a4e 50%,#e8a06c 100%); color:#fff; }
    .chat-avatar.user-av { background: linear-gradient(135deg, var(--primary) 0%, #3a7be8 100%); color:#fff; font-size:11px; }
    .chat-body { display:flex; flex-direction:column; max-width:80%; gap:3px; }
    .chat-row.user .chat-body { align-items:flex-end; }
    .bubble { padding:12px 16px; border-radius:18px; font-size:13px; line-height:1.7; animation:msgIn .2s ease; }
    @keyframes msgIn { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:none; } }
    .chat-row.user .bubble {
      background: linear-gradient(135deg, var(--primary) 0%, #3a7be8 100%);
      color:#fff; border-radius:18px 18px 4px 18px;
      box-shadow: 0 2px 8px rgba(79,143,247,.2);
    }
    .chat-row.assistant .bubble {
      background: linear-gradient(180deg, rgba(255,255,255,.04) 0%, rgba(255,255,255,.02) 100%);
      border:1px solid var(--border); color:var(--text); border-radius:4px 18px 18px 18px;
    }
    .chat-time { font-size:10px; color:var(--text-muted); padding:0 6px; opacity:.6; font-weight:500; }
    .think-dots { display:flex; align-items:center; gap:6px; padding:14px 16px; }
    .think-dots span { width:8px; height:8px; border-radius:50%; background:var(--text-muted); animation:dotPulse 1.4s infinite ease-in-out; }
    .think-dots span:nth-child(2) { animation-delay:.2s; }
    .think-dots span:nth-child(3) { animation-delay:.4s; }
    @keyframes dotPulse { 0%,80%,100% { transform:scale(.6); opacity:.3; } 40% { transform:scale(1); opacity:1; } }
    .think-status { font-size:10.5px; color:var(--text-muted); font-style:italic; padding:0 6px; }
    .chat-input-wrap {
      border-top:1px solid var(--border); padding:12px 0 0; display:flex; align-items:flex-end; position:relative;
    }
    .chat-input {
      flex:1; padding:12px 48px 12px 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.04) 0%, rgba(255,255,255,.02) 100%);
      border:1px solid var(--border); border-radius:24px; color:var(--text); font-size:13px;
      outline:none; resize:none; min-height:46px; max-height:140px; font-family:var(--font);
      line-height:1.5; transition:all var(--transition);
    }
    .chat-input:focus { border-color:var(--primary); box-shadow: 0 0 0 3px rgba(79,143,247,.08); }
    .chat-send-btn {
      position:absolute; right:7px; bottom:7px; width:34px; height:34px; border-radius:50%;
      padding:0 !important; display:flex; align-items:center; justify-content:center; font-size:18px; line-height:1;
      box-shadow: 0 2px 6px rgba(79,143,247,.3);
    }

    /* â”€â”€ Alerts â”€â”€ */
    .alert { padding:10px 14px; border-radius:var(--radius-sm); font-size:13px; display:flex; align-items:center; gap:8px; margin-bottom:12px; font-weight:500; }
    .alert.hidden { display:none; }
    .a-err  { background:rgba(240,68,68,.08); border:1px solid rgba(240,68,68,.2); color:#fca5a5; }
    .a-ok   { background:rgba(34,201,151,.08); border:1px solid rgba(34,201,151,.2); color:#6ee7b7; }
    .a-warn { background:rgba(245,166,35,.08); border:1px solid rgba(245,166,35,.2); color:#fcd34d; }

    /* â”€â”€ Modals â”€â”€ */
    .overlay { position:fixed; inset:0; background:rgba(0,0,0,.8); display:flex; align-items:center; justify-content:center; z-index:200; backdrop-filter:blur(8px); animation: overlayIn .2s ease; }
    @keyframes overlayIn { from { opacity: 0; } to { opacity: 1; } }
    .overlay.hidden { display:none; }
    .modal {
      background: linear-gradient(180deg, var(--card-elevated) 0%, var(--card) 100%);
      border:1px solid var(--border-bright); border-radius:var(--radius-lg); padding:28px;
      width:440px; max-width:92vw; box-shadow: var(--shadow-lg);
      animation: modalIn .25s ease;
    }
    @keyframes modalIn { from { opacity:0; transform:scale(.96) translateY(8px); } to { opacity:1; transform:none; } }
    .modal-title { font-size:17px; font-weight:700; margin-bottom:6px; letter-spacing:-.2px; }
    .modal-desc { font-size:13px; color:var(--text-muted); margin-bottom:20px; line-height:1.5; }

    /* â”€â”€ Misc â”€â”€ */
    .spinner { display:inline-block; width:14px; height:14px; border:2px solid var(--border); border-top-color:var(--primary); border-radius:50%; animation:spin .6s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .empty { text-align:center; padding:40px 16px; color:var(--text-muted); font-size:13px; font-weight:500; }
    .flex-row { display:flex; align-items:center; gap:8px; }
    .flex-between { display:flex; justify-content:space-between; align-items:center; }
    .mt-14 { margin-top:14px; }
    .mt-10 { margin-top:10px; }
    .section-sep { border-top:1px solid var(--border); margin:20px 0 16px; }

    /* â”€â”€ Scrollbar â”€â”€ */
    ::-webkit-scrollbar { width:6px; height:6px; }
    ::-webkit-scrollbar-track { background:transparent; }
    ::-webkit-scrollbar-thumb { background:var(--border); border-radius:4px; }
    ::-webkit-scrollbar-thumb:hover { background:var(--border-bright); }

    /* â”€â”€ dvh: iOS Safari address-bar viewport fix â”€â”€ */
    @supports (height: 100dvh) { #app { height: 100dvh; } }

    /* â”€â”€ Mobile (<=640px) â”€â”€ */
    @media (max-width: 640px) {
      #header { padding: 10px 16px; }
      .header-left { gap: 10px; }
      .logo { font-size: 14px; }
      .last-update { display: none; }
      .status-pill { padding: 3px 9px; font-size: 11px; }
      #tabs { padding: 0 6px; }
      .tab { padding: 10px 12px; font-size: 12px; }
      #content { padding: 12px 14px; }
      .card { padding: 14px; border-radius: var(--radius); }
      .chat-box { height: 52vh; }
      .log-box  { height: 44vh; }
      /* Prevent iOS auto-zoom on focus */
      .form-input, .chat-input { font-size: 16px; }
      /* Larger tap targets */
      .btn { min-height: 44px; padding: 10px 16px; }
      .btn-sm { min-height: 36px; padding: 7px 11px; }
      .icon-btn { width: 38px; height: 38px; }
      .modal { padding: 20px 16px; }
      .grid-2, .grid-3 { gap: 12px; }
      .pnl-big { font-size: 28px; }
    }

    /* â”€â”€ Tablet (641-900px) â”€â”€ */
    @media (min-width: 641px) and (max-width: 900px) {
      #content { padding: 16px 18px; }
      .card { padding: 16px; }
    }

    /* â”€â”€ Markdown in chat bubbles â”€â”€ */
    .bubble.md { line-height: 1.65; }
    .bubble.md p { margin: 0 0 10px; }
    .bubble.md p:last-child { margin-bottom: 0; }
    .bubble.md h1,.bubble.md h2,.bubble.md h3 { font-weight:700; margin:14px 0 6px; line-height:1.3; }
    .bubble.md h1 { font-size:16px; border-bottom:1px solid var(--border); padding-bottom:5px; }
    .bubble.md h2 { font-size:14px; }
    .bubble.md h3 { font-size:13px; color:var(--text-dim); }
    .bubble.md code { font-family:var(--font-mono); font-size:11.5px; background:rgba(0,0,0,.3); padding:2px 6px; border-radius:4px; border:1px solid rgba(255,255,255,.05); }
    .bubble.md pre { background:rgba(0,0,0,.35); border:1px solid var(--border); border-radius:var(--radius-sm); padding:12px 14px; margin:10px 0; overflow-x:auto; }
    .bubble.md pre code { background:none; padding:0; font-size:12px; border:none; }
    .bubble.md ul,.bubble.md ol { padding-left:20px; margin:6px 0; }
    .bubble.md li { margin:4px 0; }
    .bubble.md strong { font-weight:700; color:var(--text); }
    .bubble.md em { color:var(--text-dim); }
    .bubble.md blockquote { border-left:3px solid var(--primary); margin:8px 0; padding:6px 12px; color:var(--text-dim); font-style:italic; background:rgba(79,143,247,.03); border-radius:0 4px 4px 0; }
    .bubble.md hr { border:none; border-top:1px solid var(--border); margin:12px 0; }
    .bubble.md table { border-collapse:collapse; width:100%; margin:10px 0; font-size:12px; }
    .bubble.md th { background:rgba(255,255,255,.05); }
    .bubble.md th,.bubble.md td { border:1px solid var(--border); padding:6px 12px; text-align:left; }
    .bubble.md a { color:var(--primary); text-decoration:none; font-weight:500; }
    .bubble.md a:hover { text-decoration:underline; }
  </style>
</head>
<body>
<div id="app">

  <!-- â•â•â• HEADER â•â•â• -->
  <header id="header">
    <div class="header-left">
      <span class="logo">Japan <span>225</span> Bot</span>
      <div class="status-pill">
        <span class="status-dot" id="sDot"></span>
        <span id="sLabel">Not connected</span>
      </div>
    </div>
    <div class="header-right">
      <span class="last-update" id="lastUpdate"></span>
      <button class="icon-btn" onclick="refreshCurrent()" title="Refresh">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0018.49 15"/></svg>
      </button>
      <button class="icon-btn" onclick="openSettings()" title="API Settings">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
      </button>
    </div>
  </header>

  <!-- â•â•â• TABS â•â•â• -->
  <nav id="tabs">
    <button class="tab active" data-tab="overview" onclick="switchTab(this,'overview')">Overview</button>
    <button class="tab" data-tab="config"   onclick="switchTab(this,'config')">Config</button>
    <button class="tab" data-tab="history"  onclick="switchTab(this,'history')">History</button>
    <button class="tab" data-tab="logs"     onclick="switchTab(this,'logs')">Logs</button>
    <button class="tab" data-tab="chat"     onclick="switchTab(this,'chat')">Chat</button>
    <button class="tab" data-tab="controls" onclick="switchTab(this,'controls')">Controls</button>
  </nav>

  <!-- â•â•â• CONTENT â•â•â• -->
  <main id="content">

    <!-- â”€â”€ Overview â”€â”€ -->
    <div id="tab-overview" class="tab-panel active">
      <div class="grid-2" style="margin-bottom:16px;">
        <div class="card">
          <div class="card-title">Bot Status</div>
          <div id="statusRows"><div class="empty"><span class="spinner"></span></div></div>
        </div>
        <div class="card" id="posCard">
          <div class="card-title">Active Position</div>
          <div id="posPanel"><div class="empty"><span class="spinner"></span></div></div>
        </div>
      </div>
      <div class="card">
        <div class="flex-between" style="margin-bottom:14px;">
          <div class="card-title" style="margin-bottom:0">Recent Scans</div>
          <button class="btn btn-ghost btn-sm" onclick="loadOverview()">Refresh</button>
        </div>
        <div class="tbl-wrap">
          <table>
            <thead><tr>
              <th class="sortable sort-active" onclick="sortScans(0)" id="sh0">Time <i class="sort-icon">â–¼</i></th>
              <th class="sortable" onclick="sortScans(1)" id="sh1">Session <i class="sort-icon">â†•</i></th>
              <th class="sortable" onclick="sortScans(2)" id="sh2">Price <i class="sort-icon">â†•</i></th>
              <th class="sortable" onclick="sortScans(3)" id="sh3">Direction <i class="sort-icon">â†•</i></th>
              <th class="sortable" onclick="sortScans(4)" id="sh4">Confidence <i class="sort-icon">â†•</i></th>
              <th>Action</th>
            </tr></thead>
            <tbody id="scansBody"><tr><td colspan="6" class="empty">Loadingâ€¦</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- â”€â”€ Config â”€â”€ -->
    <div id="tab-config" class="tab-panel">
      <div class="grid-2">
        <div class="card">
          <div class="card-title">Hot-Reload Settings</div>
          <p style="font-size:11px;color:var(--text-muted);margin-bottom:16px;padding-left:11px;border-left:2px solid var(--long);line-height:1.4;">Applied immediately -- no restart needed</p>

          <div class="form-group">
            <div class="form-label">Min Confidence LONG (%)</div>
            <div class="range-row">
              <input type="range" id="cMinConf" min="50" max="95" step="5" oninput="syncRange(this,'vMinConf')">
              <span class="range-val" id="vMinConf">70</span>
            </div>
          </div>
          <div class="form-group">
            <div class="form-label">Min Confidence SHORT (%)</div>
            <div class="range-row">
              <input type="range" id="cMinConfS" min="50" max="95" step="5" oninput="syncRange(this,'vMinConfS')">
              <span class="range-val" id="vMinConfS">75</span>
            </div>
          </div>
          <div class="form-group">
            <div class="form-label">AI Cooldown (min)</div>
            <div class="range-row">
              <input type="range" id="cAICool" min="5" max="120" step="5" oninput="syncRange(this,'vAICool')">
              <span class="range-val" id="vAICool">30</span>
            </div>
          </div>
          <div class="form-group">
            <div class="form-label">Scan Interval (sec)</div>
            <div class="range-row">
              <input type="range" id="cScanInt" min="60" max="600" step="30" oninput="syncRange(this,'vScanInt')">
              <span class="range-val" id="vScanInt">300</span>
            </div>
          </div>

          <div class="toggle-row">
            <div class="toggle-info">
              <div class="t-name">Pause Scanning</div>
              <div class="t-desc">Halt all market scans temporarily</div>
            </div>
            <label class="toggle"><input type="checkbox" id="cPaused"><span class="tgl-slider"></span></label>
          </div>
          <div class="toggle-row">
            <div class="toggle-info">
              <div class="t-name">Debug Mode</div>
              <div class="t-desc">Verbose logging output</div>
            </div>
            <label class="toggle"><input type="checkbox" id="cDebug"><span class="tgl-slider"></span></label>
          </div>

          <div class="mt-14">
            <button class="btn btn-primary" onclick="saveHot()">Apply Hot Config</button>
          </div>
          <div id="cfgHotAlert" class="alert hidden mt-10"></div>
        </div>

        <div class="card">
          <div class="card-title">Restart-Required Settings</div>
          <p style="font-size:11px;color:var(--text-muted);margin-bottom:16px;padding-left:11px;border-left:2px solid var(--warning);line-height:1.4;">Blocked while position is open -- Triggers bot restart on save</p>

          <div class="form-group">
            <div class="form-label">Breakeven Trigger (pts)</div>
            <input type="number" class="form-input" id="cBreakeven" value="150">
          </div>
          <div class="form-group">
            <div class="form-label">Trailing Stop Distance (pts)</div>
            <input type="number" class="form-input" id="cTrailing" value="150">
          </div>
          <div class="form-group">
            <div class="form-label">Default SL Distance (pts)</div>
            <input type="number" class="form-input" id="cSL" value="200">
          </div>
          <div class="form-group">
            <div class="form-label">Default TP Distance (pts)</div>
            <input type="number" class="form-input" id="cTP" value="400">
          </div>
          <div class="form-group">
            <div class="form-label">Max Margin (%)</div>
            <input type="number" class="form-input" id="cMargin" value="50" min="1" max="100">
            <div class="form-hint">Percentage of account balance</div>
          </div>

          <div class="mt-14">
            <button class="btn btn-warn" onclick="saveRestart()">Save &amp; Restart Bot</button>
          </div>
          <div id="cfgRestartAlert" class="alert hidden mt-10"></div>
        </div>
      </div>
    </div>

    <!-- â”€â”€ History â”€â”€ -->
    <div id="tab-history" class="tab-panel">
      <div class="card">
        <div class="flex-between" style="margin-bottom:14px;">
          <div class="card-title" style="margin-bottom:0">Trade Journal</div>
          <div class="flex-row">
            <span id="histStats" style="font-size:12px;color:var(--text-muted);font-weight:600;background:var(--bg);padding:3px 10px;border-radius:5px;border:1px solid var(--border);"></span>
            <button class="btn btn-ghost btn-sm" onclick="loadHistory()">Refresh</button>
          </div>
        </div>
        <div class="tbl-wrap">
          <table>
            <thead><tr><th>Date</th><th>Dir</th><th>Entry</th><th>Exit</th><th>PnL (pts)</th><th>Duration</th><th>Phase</th><th>Reason</th></tr></thead>
            <tbody id="histBody"><tr><td colspan="8" class="empty">Loadingâ€¦</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- â”€â”€ Logs â”€â”€ -->
    <div id="tab-logs" class="tab-panel">
      <div class="card">
        <div class="flex-between" style="margin-bottom:14px;">
          <div class="card-title" style="margin-bottom:0">Log Viewer</div>
          <div class="flex-row" style="gap:6px;">
            <button class="btn btn-ghost btn-sm" id="lTabScan" onclick="switchLogType('scan')">Scan Log</button>
            <button class="btn btn-ghost btn-sm" id="lTabSys" onclick="switchLogType('system')">System Log</button>
            <button class="btn btn-ghost btn-sm" onclick="loadLogs()">Refresh</button>
          </div>
        </div>
        <div id="logBox" class="log-box">Loading...</div>
      </div>
    </div>

    <!-- â”€â”€ Chat â”€â”€ -->
    <div id="tab-chat" class="tab-panel">
      <div class="card">
        <div class="flex-between" style="margin-bottom:12px;">
          <div style="display:flex;align-items:center;gap:10px;">
            <div style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#c96a1e,#d98a4e,#e8a06c);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;box-shadow:0 2px 6px rgba(201,106,30,.3);">âœ¦</div>
            <span class="card-title" style="margin-bottom:0">Claude</span>
            <span style="font-size:11px;color:var(--text-muted);font-weight:500;">-- agentic, reads files &amp; pushes fixes</span>
          </div>
          <div style="display:flex;align-items:center;gap:10px;">
            <span id="chatCostBadge" style="font-size:11px;color:var(--text-muted);font-weight:500;background:var(--bg);padding:3px 8px;border-radius:4px;border:1px solid var(--border);">cost: --</span>
            <button class="btn btn-ghost btn-sm" onclick="clearChat()">Clear</button>
          </div>
        </div>
        <div id="chatBox" class="chat-box"></div>
        <div class="chat-input-wrap">
          <textarea id="chatInput" class="chat-input" rows="1" placeholder="Message Claudeâ€¦" onkeydown="chatKey(event)"></textarea>
          <button class="btn btn-primary chat-send-btn" id="chatBtn" onclick="sendChat()">â†‘</button>
        </div>
      </div>
    </div>

    <!-- â”€â”€ Controls â”€â”€ -->
    <div id="tab-controls" class="tab-panel">
      <div class="grid-2">
        <div class="card">
          <div class="card-title">Bot Controls</div>
          <div id="ctrlAlert" class="alert hidden"></div>

          <div style="display:flex;flex-direction:column;gap:0;">
            <div style="padding:16px 4px;border-bottom:1px solid rgba(23,32,51,.7);">
              <div style="font-weight:700;font-size:13px;margin-bottom:4px;color:var(--text);">Force Scan</div>
              <div style="font-size:12px;color:var(--text-muted);margin-bottom:12px;line-height:1.5;">Trigger an immediate market scan now</div>
              <button class="btn btn-success" onclick="doControl('force-scan')">&#9654; Force Scan Now</button>
            </div>
            <div style="padding:16px 4px;border-bottom:1px solid rgba(23,32,51,.7);">
              <div style="font-weight:700;font-size:13px;margin-bottom:4px;color:var(--text);">Restart Bot</div>
              <div style="font-size:12px;color:var(--text-muted);margin-bottom:12px;line-height:1.5;">Restarts monitor service. Warns if position is open.</div>
              <button class="btn btn-warn" onclick="doControl('restart')">&#8634; Restart Bot</button>
            </div>
            <div style="padding:16px 4px;">
              <div style="font-weight:700;font-size:13px;margin-bottom:4px;color:var(--text);">Stop Bot</div>
              <div style="font-size:12px;color:var(--text-muted);margin-bottom:12px;line-height:1.5;">Stops the monitor service entirely</div>
              <button class="btn btn-danger" onclick="doControl('stop')">&#9632; Stop Bot</button>
            </div>
          </div>
        </div>

      </div>
    </div>

  </main>
</div>

<!-- â•â•â• SETTINGS MODAL â•â•â• -->
<div id="settingsOverlay" class="overlay hidden">
  <div class="modal">
    <div class="modal-title">API Connection</div>
    <div class="modal-desc">Your backend URL and token are saved only in your browser (localStorage).</div>
    <div class="form-group">
      <div class="form-label">Backend API URL</div>
      <input type="url" class="form-input" id="sUrl" placeholder="https://xxxx.ngrok-free.app">
      <div class="form-hint">ngrok / Cloudflare tunnel URL -- no trailing slash</div>
    </div>
    <div class="form-group">
      <div class="form-label">Dashboard Token</div>
      <input type="password" class="form-input" id="sToken" placeholder="&#8226;&#8226;&#8226;&#8226;&#8226;&#8226;&#8226;&#8226;&#8226;&#8226;&#8226;&#8226;&#8226;&#8226;&#8226;&#8226;">
      <div class="form-hint">DASHBOARD_TOKEN from your .env file</div>
    </div>
    <div id="sAlert" class="alert hidden"></div>
    <div class="flex-row mt-14">
      <button class="btn btn-primary" onclick="saveSettings()">Save &amp; Connect</button>
      <button class="btn btn-ghost" onclick="closeSettings()">Cancel</button>
    </div>
  </div>
</div>

<!-- â•â•â• CONFIRM MODAL â•â•â• -->
<div id="confirmOverlay" class="overlay hidden">
  <div class="modal">
    <div class="modal-title" id="confTitle"></div>
    <div class="modal-desc" id="confDesc"></div>
    <div class="flex-row mt-14">
      <button class="btn btn-danger" id="confOk">Confirm</button>
      <button class="btn btn-ghost" onclick="closeConfirm(false)">Cancel</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S = {
  url:    localStorage.getItem('apiUrl')   || '',
  token:  localStorage.getItem('apiToken') || '',
  tab:    'overview',
  logType: 'scan',
  chat:   [],          // history [{role,content}]
  historyUpdatedAt: '', // last known server timestamp for cross-device sync
  timer:  null,
  pendingJob: null,    // {job_id, timer, thinkEl} â€” survives ngrok reconnect via localStorage
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CROSS-TAB SYNC (BroadcastChannel)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const bc = typeof BroadcastChannel !== 'undefined' ? new BroadcastChannel('j225') : null;
if (bc) {
  bc.onmessage = e => {
    const { type, data } = e.data;
    if (type === 'chat') {
      // Another tab updated chat â€” re-render our chat box
      S.chat = data;
      const box = document.getElementById('chatBox');
      if (box) { box.innerHTML = ''; data.forEach(m => addMsg(m.role, m.content)); }
    } else if (type === 'config-changed') {
      // Another tab saved config â€” reload ours from server
      if (S.url && S.tab === 'config') loadConfig();
    }
  };
}
function bcPost(type, data) { if (bc) bc.postMessage({ type, data }); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function req(method, path, body) {
  if (!S.url) throw Object.assign(new Error('NOT_CONFIGURED'), {code:'NOT_CONFIGURED'});
  const r = await fetch(S.url + path, {
    method,
    headers: { 'Authorization': 'Bearer ' + S.token, 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
    body: body ? JSON.stringify(body) : undefined,
  });
  const d = await r.json().catch(() => ({}));
  if (!r.ok) throw new Error(d.detail || 'HTTP ' + r.status);
  return d;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONNECTION UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setConn(state, label) {
  const dot = document.getElementById('sDot');
  const lbl = document.getElementById('sLabel');
  dot.className = 'status-dot' + (state === 'ok' ? ' ok' : state === 'err' ? ' err' : '');
  lbl.textContent = label;
}
function touchUpdate() {
  document.getElementById('lastUpdate').textContent = 'Updated ' + new Date().toLocaleTimeString();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(btn, name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === name));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  S.tab = name;
  const loaders = { overview: loadOverview, history: loadHistory, logs: loadLogs, config: loadConfig };
  if (loaders[name]) loaders[name]();
  if (name === 'chat') { const b = document.getElementById('chatBox'); if (b) b.scrollTop = b.scrollHeight; }
  if (name === 'chat') _refreshChatCost();
}
function refreshCurrent() {
  const loaders = { overview: loadOverview, history: loadHistory, logs: loadLogs, config: loadConfig };
  if (loaders[S.tab]) loaders[S.tab]();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OVERVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadOverview() {
  if (!S.url) { showNotConfigured(); return; }
  try {
    const d = await req('GET', '/api/status');
    setConn('ok', 'Connected');
    touchUpdate();
    _seedCountdown(d.next_scan_in, d.last_scan);
    renderStatus(d);
    renderPos(d.position);
    renderScans(d.recent_scans || []);
  } catch(e) {
    if (e.code === 'NOT_CONFIGURED') { showNotConfigured(); return; }
    setConn('err', 'Error');
    document.getElementById('statusRows').innerHTML = `<div class="alert a-err">âš  ${esc(e.message)}</div>`;
  }
}

function renderStatus(d) {
  const det = d.last_scan_detail || {};
  let lastScanHtml = 'â€”';
  if (det.outcome) {
    const outcomeMap = {
      no_setup:      '<span class="badge b-neutral">No Setup</span>',
      cooldown:      '<span class="badge b-warn">Cooldown</span>',
      low_conf:      '<span class="badge b-neutral">Low Conf</span>',
      event_block:   '<span class="badge b-warn">Event Block</span>',
      friday_block:  '<span class="badge b-warn">Fri Block</span>',
      haiku_rejected:'<span class="badge b-neutral">Haiku âœ—</span>',
      ai_rejected:   '<span class="badge b-neutral">AI âœ—</span>',
      trade_alert:   '<span class="badge b-long">Trade Alert!</span>',
    };
    const badge = outcomeMap[det.outcome] || `<span class="badge b-neutral">${esc(det.outcome)}</span>`;
    const dir   = det.direction ? ` ${det.direction}` : '';
    const conf  = det.confidence != null ? ` ${det.confidence}%` : '';
    lastScanHtml = badge + `<span style="font-size:12px;color:var(--text-muted);margin-left:6px;">${esc(dir + conf)}</span>`;
  }
  const phaseHtml = {
    MONITORING:      '<span class="badge b-long">ğŸ“Š MONITORING</span>',
    COOLDOWN:        '<span class="badge b-warn">â³ COOLDOWN</span>',
    SCANNING:        '<span class="badge b-neutral">ğŸ” SCANNING</span>',
    STARTING:        '<span class="badge b-blue">â³ STARTING</span>',
    IG_DISCONNECTED: '<span class="badge b-warn">âš  IG OFFLINE</span>',
  }[d.phase] || `<span class="badge b-neutral">${esc(d.phase||'â€”')}</span>`;
  const rows = [
    ['Session',        d.session      || 'â€”'],
    ['Phase',          phaseHtml],
    ['Scanning',       d.scanning_paused
      ? '<span class="badge b-warn">PAUSED</span>'
      : '<span class="badge b-long">ACTIVE</span>'],
    ['Last Scan',      `<span id="lastScanVal">${d.last_scan ? ago(d.last_scan) : 'â€”'}</span>`],
    ['Last Result',    lastScanHtml],
    ['Next Scan In',   `<span id="nextScanVal">${fmtCountdown(d.next_scan_in)}</span>`],
    ['AI Calls Today', d.ai_calls_today ?? 'â€”'],
    ['Bot Tokens',     d.tokens_today ? `~${(d.tokens_today.tokens/1000).toFixed(1)}k (${d.tokens_today.scans} scans)` : 'â€”'],
    ['Chat Tokens',    d.chat_tokens_today != null ? `~${(d.chat_tokens_today/1000).toFixed(1)}k` : 'â€”'],
    ['Uptime',         d.uptime       || 'â€”'],
  ];
  document.getElementById('statusRows').innerHTML = rows.map(([l,v]) =>
    `<div class="stat-row"><span class="stat-label">${l}</span><span class="stat-value">${v}</span></div>`
  ).join('');
}

function renderPos(p) {
  const el = document.getElementById('posPanel');
  if (!p) {
    el.innerHTML = `<div class="no-pos">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
      <span>No active position</span></div>`;
    return;
  }
  const pnl = p.unrealised_pnl ?? 0;
  const pClass = pnl >= 0 ? 'c-long' : 'c-short';
  const pSign  = pnl >= 0 ? '+' : '';
  const dir    = p.direction === 'LONG'
    ? '<span class="badge b-long">â–² LONG</span>'
    : '<span class="badge b-short">â–¼ SHORT</span>';
  const phases = ['INITIAL','BREAKEVEN','RUNNER'];
  const pi = phases.indexOf(p.phase || 'INITIAL');
  const steps = phases.map((_, i) =>
    `<div class="phase-step ${i < pi ? 'done' : i === pi ? 'active' : ''}"></div>`
  ).join('');
  el.innerHTML = `
    <div class="flex-between" style="margin-bottom:12px;">
      ${dir}
      <div class="pnl-big ${pClass}">${pSign}${pnl.toFixed(0)}</div>
    </div>
    <div class="stat-row"><span class="stat-label">Entry</span><span class="stat-value">${fmt1(p.entry_price)}</span></div>
    <div class="stat-row"><span class="stat-label">Current</span><span class="stat-value">${fmt1(p.current_price)}</span></div>
    <div class="stat-row"><span class="stat-label">Stop Loss</span><span class="stat-value c-short">${fmt1(p.stop_loss)}</span></div>
    <div class="stat-row"><span class="stat-label">Take Profit</span><span class="stat-value c-long">${fmt1(p.take_profit)}</span></div>
    <div class="stat-row"><span class="stat-label">Size</span><span class="stat-value">${p.size ?? 'â€”'}</span></div>
    <div class="stat-row"><span class="stat-label">Duration</span><span class="stat-value">${p.duration || 'â€”'}</span></div>
    <div class="phase-bar">
      <div class="phase-lbl">Phase: ${p.phase || 'INITIAL'}</div>
      <div class="phase-steps">${steps}</div>
    </div>`;
}

const _actionLabels = {
  no_setup:            'â€”',
  cooldown_long:       'â³ Cooldown (L)',
  cooldown_short:      'â³ Cooldown (S)',
  event_block_long:    'ğŸš« Event (L)',
  event_block_short:   'ğŸš« Event (S)',
  friday_block_long:   'ğŸš« Fri (L)',
  friday_block_short:  'ğŸš« Fri (S)',
  low_conf_long:       'ğŸ“‰ Low conf (L)',
  low_conf_short:      'ğŸ“‰ Low conf (S)',
  haiku_rejected:       'ğŸ¤– Haiku âœ—',
  haiku_rejected_long:  'ğŸ¤– Haiku âœ— (L)',
  haiku_rejected_short: 'ğŸ¤– Haiku âœ— (S)',
  ai_rejected_long:     'ğŸ¤– AI âœ— (L)',
  ai_rejected_short:    'ğŸ¤– AI âœ— (S)',
  pending:              'ğŸ“¤ Alert sent',
  pending_long:         'ğŸ“¤ Alert (L)',
  pending_short:        'ğŸ“¤ Alert (S)',
};

let _scansData = [];
let _scanSort  = { col: 0, asc: false };  // default: time desc

function sortScans(col) {
  if (_scanSort.col === col) { _scanSort.asc = !_scanSort.asc; }
  else { _scanSort = { col, asc: col !== 0 }; }
  // Update header icons
  for (let i = 0; i < 5; i++) {
    const th = document.getElementById('sh' + i);
    if (!th) continue;
    th.classList.toggle('sort-active', i === col);
    const ic = th.querySelector('.sort-icon');
    if (ic) ic.textContent = i === col ? (_scanSort.asc ? 'â–²' : 'â–¼') : 'â†•';
  }
  _renderScansTable(_scansData);
}

function renderScans(scans) {
  _scansData = scans;
  _renderScansTable(scans);
}

function _renderScansTable(scans) {
  const tb = document.getElementById('scansBody');
  if (!scans.length) { tb.innerHTML = '<tr><td colspan="6" class="empty">No scans during active session yet</td></tr>'; return; }
  const sortFns = [
    (a,b) => (a.timestamp||'').localeCompare(b.timestamp||''),
    (a,b) => (a.session||'').localeCompare(b.session||''),
    (a,b) => (a.price||0) - (b.price||0),
    (a,b) => (a.direction||'').localeCompare(b.direction||''),
    (a,b) => (a.confidence??-1) - (b.confidence??-1),
  ];
  const sorted = [...scans].sort((a,b) => {
    const r = sortFns[_scanSort.col]?.(a,b) ?? 0;
    return _scanSort.asc ? r : -r;
  });
  tb.innerHTML = sorted.map(s => {
    const act = s.action_taken || '';
    const dir = s.direction;
    const isCooldown = act.startsWith('cooldown_');
    const setup = s.setup_found
      ? `<span class="badge b-long">${dir || 'Found'}</span>`
      : dir
        ? `<span class="badge b-neutral">${dir}</span>`
        : '<span class="badge b-neutral">â€”</span>';
    const conf = s.confidence != null
      ? `<span class="${s.confidence >= 70 ? 'c-long' : s.confidence >= 40 ? 'c-warn' : 'c-dim'}">${s.confidence}%</span>`
      : 'â€”';
    const action = _actionLabels[act] || (act ? esc(act) : 'â€”');
    const cdAge = isCooldown && s.timestamp
      ? (Date.now() - new Date(_utc(s.timestamp))) / 60000
      : Infinity;
    const escalateBtn = isCooldown && cdAge < 15
      ? ` <button class="btn btn-warn btn-sm" style="padding:2px 7px;font-size:11px;" onclick="escalateNow(this)" title="Clear cooldown and escalate to Haiku immediately">â†‘ Escalate</button>`
      : '';
    return `<tr>
      <td>${fmtTime(s.timestamp)}</td>
      <td>${s.session || 'â€”'}</td>
      <td>${fmt1(s.price)}</td>
      <td>${setup}</td>
      <td>${conf}</td>
      <td style="font-size:12px;">${action}${escalateBtn}</td>
    </tr>`;
  }).join('');
}

async function escalateNow(btn) {
  btn.disabled = true;
  btn.textContent = 'â³ Sendingâ€¦';
  try {
    await req('POST', '/api/controls/clear-cooldown');
    btn.textContent = 'âœ“ Escalating!';
    btn.className = 'btn btn-success btn-sm';
    btn.style.cssText = 'padding:2px 7px;font-size:11px;';
    setTimeout(loadOverview, 2500);
  } catch(e) {
    btn.textContent = 'âœ— Failed';
    btn.disabled = false;
  }
}

function showNotConfigured() {
  setConn('', 'Not configured');
  document.getElementById('statusRows').innerHTML = `
    <div style="padding:24px;text-align:center;">
      <div style="font-size:13px;color:var(--text-muted);margin-bottom:12px;">Click âš™ to enter your backend URL</div>
      <button class="btn btn-primary btn-sm" onclick="openSettings()">Configure Connection</button>
    </div>`;
  document.getElementById('posPanel').innerHTML = '';
  document.getElementById('scansBody').innerHTML = '<tr><td colspan="6" class="empty">Not connected</td></tr>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadConfig() {
  if (!S.url) return;
  try {
    const d = await req('GET', '/api/config');
    setR('cMinConf',  'vMinConf',  d.MIN_CONFIDENCE          ?? 70);
    setR('cMinConfS', 'vMinConfS', d.MIN_CONFIDENCE_SHORT     ?? 75);
    setR('cAICool',   'vAICool',   d.AI_COOLDOWN_MINUTES      ?? 30);
    setR('cScanInt',  'vScanInt',  d.SCAN_INTERVAL_SECONDS    ?? 300);
    document.getElementById('cPaused').checked  = !!d.scanning_paused;
    document.getElementById('cDebug').checked   = !!d.DEBUG;
    document.getElementById('cBreakeven').value = d.BREAKEVEN_TRIGGER       ?? 150;
    document.getElementById('cTrailing').value  = d.TRAILING_STOP_DISTANCE  ?? 150;
    document.getElementById('cSL').value        = d.DEFAULT_SL_DISTANCE     ?? 200;
    document.getElementById('cTP').value        = d.DEFAULT_TP_DISTANCE     ?? 400;
    document.getElementById('cMargin').value    = d.MAX_MARGIN_PERCENT != null
      ? Math.round(d.MAX_MARGIN_PERCENT * 100) : 50;
  } catch(_) {}
}
function setR(iId, vId, val) {
  document.getElementById(iId).value = val;
  document.getElementById(vId).textContent = val;
}
function syncRange(el, vId) { document.getElementById(vId).textContent = el.value; }

async function saveHot() {
  try {
    await req('POST', '/api/config', {
      tier: 'hot',
      MIN_CONFIDENCE:       +document.getElementById('cMinConf').value,
      MIN_CONFIDENCE_SHORT: +document.getElementById('cMinConfS').value,
      AI_COOLDOWN_MINUTES:  +document.getElementById('cAICool').value,
      SCAN_INTERVAL_SECONDS:+document.getElementById('cScanInt').value,
      scanning_paused:       document.getElementById('cPaused').checked,
      DEBUG:                 document.getElementById('cDebug').checked,
    });
    alert2('cfgHotAlert', 'ok', 'âœ“ Hot config applied.');
    bcPost('config-changed', null);
  } catch(e) { alert2('cfgHotAlert', 'err', 'âœ— ' + e.message); }
}
async function saveRestart() {
  try {
    await req('POST', '/api/config', {
      tier: 'restart',
      BREAKEVEN_TRIGGER:      +document.getElementById('cBreakeven').value,
      TRAILING_STOP_DISTANCE: +document.getElementById('cTrailing').value,
      DEFAULT_SL_DISTANCE:    +document.getElementById('cSL').value,
      DEFAULT_TP_DISTANCE:    +document.getElementById('cTP').value,
      MAX_MARGIN_PERCENT:     +document.getElementById('cMargin').value / 100,
    });
    alert2('cfgRestartAlert', 'ok', 'âœ“ Saved. Bot restartingâ€¦');
    bcPost('config-changed', null);
  } catch(e) { alert2('cfgRestartAlert', 'err', 'âœ— ' + e.message); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HISTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadHistory() {
  if (!S.url) return;
  try {
    const d = await req('GET', '/api/history');
    const trades = d.trades || [];
    const wins   = trades.filter(t => (t.pnl ?? 0) > 0).length;
    const totPnl = trades.reduce((s,t) => s + (t.pnl ?? 0), 0);
    document.getElementById('histStats').textContent = trades.length
      ? `${trades.length} trades Â· ${wins}W/${trades.length-wins}L Â· ${totPnl >= 0 ? '+' : ''}${totPnl.toFixed(0)} pts` : '';
    const tb = document.getElementById('histBody');
    if (!trades.length) { tb.innerHTML = '<tr><td colspan="8" class="empty">No trades yet</td></tr>'; return; }
    tb.innerHTML = trades.map(t => {
      const pnl = t.pnl ?? 0;
      const pc  = pnl >= 0 ? 'c-long' : 'c-short';
      return `<tr>
        <td>${fmtDt(t.opened_at)}</td>
        <td>${t.direction==='LONG'
          ? '<span class="badge b-long">L</span>'
          : '<span class="badge b-short">S</span>'}</td>
        <td>${fmt1(t.entry_price)}</td>
        <td>${fmt1(t.exit_price)}</td>
        <td class="${pc}" style="font-weight:700;">${(pnl>=0?'+':'')+pnl.toFixed(0)}</td>
        <td>${t.duration || 'â€”'}</td>
        <td>${t.exit_phase || 'â€”'}</td>
        <td style="font-size:11px;">${t.close_reason || 'â€”'}</td>
      </tr>`;
    }).join('');
  } catch(e) {
    document.getElementById('histBody').innerHTML = `<tr><td colspan="8" class="empty">Error: ${esc(e.message)}</td></tr>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchLogType(which) {
  S.logType = which;
  document.getElementById('lTabScan').style.color   = which==='scan'   ? 'var(--primary)' : '';
  document.getElementById('lTabSys').style.color    = which==='system' ? 'var(--primary)' : '';
  loadLogs();
}
async function loadLogs() {
  if (!S.url) return;
  const box = document.getElementById('logBox');
  try {
    const d = await req('GET', '/api/logs?type=' + S.logType + '&lines=70');
    const lines = d.lines || [];
    if (!lines.length) { box.innerHTML = '<span class="l-info">No entries</span>'; return; }
    box.innerHTML = lines.map(l => {
      let c = 'l-info';
      if (/ERROR|CRITICAL/i.test(l)) c = 'l-err';
      else if (/WARN/i.test(l))      c = 'l-warn';
      else if (/TRADE|OPEN|CLOSE|CONFIRM|SIGNAL/i.test(l)) c = 'l-trade';
      return `<div class="${c}">${esc(l)}</div>`;
    }).join('');
    box.scrollTop = box.scrollHeight;
  } catch(e) { box.innerHTML = `<span class="l-err">Error: ${esc(e.message)}</span>`; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function chatKey(e) { if (e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); } }

async function sendChat() {
  const inp = document.getElementById('chatInput');
  const msg = inp.value.trim();
  if (!msg || !S.url) { if (!S.url) openSettings(); return; }
  inp.value = '';
  addMsg('user', msg);
  if (S.chat.length >= 20) S.chat.splice(0, 2);
  S.chat.push({ role:'user', content: msg });
  _saveHistory();
  const btn = document.getElementById('chatBtn');
  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>';
  // Show thinking bubble immediately â€” survives ngrok drops
  const thinkEl = _addThinkingBubble();
  const statusEl = thinkEl.querySelector('.think-status');
  // Retry POST until ngrok reconnects â€” never give up
  let posted = false;
  while (!posted) {
    try {
      const d = await req('POST', '/api/chat', { message: msg, history: S.chat });
      posted = true;
      if (d.job_id) {
        localStorage.setItem('pendingJob', JSON.stringify({ job_id: d.job_id }));
        _startJobPolling(d.job_id, thinkEl);
        // button stays disabled until job finishes (managed inside _startJobPolling)
      } else if (d.response) {
        // Legacy sync fallback
        if (thinkEl) thinkEl.remove();
        S.chat.push({ role:'assistant', content: d.response });
        _saveHistory();
        addMsg('assistant', d.response);
        _refreshChatCost();
        btn.disabled = false; btn.innerHTML = 'Send';
      }
    } catch(_) {
      // ngrok dropped â€” keep thinking bubble, retry in 5s
      if (statusEl) statusEl.textContent = 'Reconnectingâ€¦';
      await new Promise(r => setTimeout(r, 5000));
      if (statusEl) statusEl.textContent = 'Retryingâ€¦';
    }
  }
}

const _thinkPhrases = ['Thinkingâ€¦', 'Reading filesâ€¦', 'Checking logsâ€¦', 'Still workingâ€¦', 'Almost doneâ€¦', 'Finalisingâ€¦'];

function _addThinkingBubble() {
  const box = document.getElementById('chatBox');
  const d = document.createElement('div');
  d.className = 'chat-row assistant';
  d.innerHTML = `<div class="chat-avatar claude">âœ¦</div>
    <div class="chat-body">
      <div class="bubble"><div class="think-dots"><span></span><span></span><span></span></div></div>
      <div class="think-status">Thinkingâ€¦</div>
    </div>`;
  box.appendChild(d);
  box.scrollTop = box.scrollHeight;
  return d;
}

function _startJobPolling(jobId, thinkEl) {
  if (S.pendingJob && S.pendingJob.timer) clearInterval(S.pendingJob.timer);
  const statusEl = thinkEl ? thinkEl.querySelector('.think-status') : null;
  let attempt = 0;

  const poll = async () => {
    attempt++;
    if (statusEl) statusEl.textContent = _thinkPhrases[Math.min(Math.floor(attempt / 2), _thinkPhrases.length - 1)];
    try {
      const d = await req('GET', '/api/chat/status/' + jobId);
      if (d.status === 'done' || d.status === 'error') {
        clearInterval(S.pendingJob && S.pendingJob.timer);
        localStorage.removeItem('pendingJob');
        S.pendingJob = null;
        if (thinkEl) thinkEl.remove();
        const btn = document.getElementById('chatBtn');
        if (btn) { btn.disabled = false; btn.innerHTML = 'Send'; }
        const reply = d.response || '(no response)';
        S.chat.push({ role:'assistant', content: reply });
        _saveHistory();
        addMsg('assistant', reply);
        _refreshChatCost();
      }
    } catch(_) {
      // ngrok down â€” show reconnecting status, keep polling
      if (statusEl) statusEl.textContent = 'Reconnectingâ€¦';
    }
  };

  const timer = setInterval(poll, 4000);
  S.pendingJob = { job_id: jobId, timer, thinkEl };
}
function addMsg(role, text, time) {
  const box = document.getElementById('chatBox');
  const d = document.createElement('div');
  d.className = 'chat-row ' + role;
  const t = time || new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  const avatarClass = role === 'assistant' ? 'claude' : 'user-av';
  const avatarLabel = role === 'assistant' ? 'âœ¦' : 'You';
  const content = role === 'assistant'
    ? marked.parse(text)
    : esc(text).replace(/\n/g,'<br>');
  d.innerHTML = `<div class="chat-avatar ${avatarClass}">${avatarLabel}</div>
    <div class="chat-body">
      <div class="bubble${role === 'assistant' ? ' md' : ''}">${content}</div>
      <div class="chat-time">${t}</div>
    </div>`;
  box.appendChild(d);
  box.scrollTop = box.scrollHeight;
}

function _saveHistory() {
  localStorage.setItem('chatHistory', JSON.stringify(S.chat));
  bcPost('chat', S.chat);  // same-browser tabs (instant)
  // Push to server so other devices pick it up via polling
  if (S.url) req('POST', '/api/chat/history', { messages: S.chat })
    .then(d => { if (d.updated_at) S.historyUpdatedAt = d.updated_at; })
    .catch(() => {});
}

// â”€â”€ Cross-device chat sync: poll server every 5s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function _pollHistory() {
  if (!S.url) return;
  try {
    const d = await req('GET', '/api/chat/history');
    if (d.updated_at && d.updated_at !== S.historyUpdatedAt &&
        Array.isArray(d.messages) && d.messages.length > 0) {
      S.historyUpdatedAt = d.updated_at;
      S.chat = d.messages;
      localStorage.setItem('chatHistory', JSON.stringify(S.chat));
      const box = document.getElementById('chatBox');
      if (box) { box.innerHTML = ''; S.chat.forEach(m => addMsg(m.role, m.content)); }
    }
  } catch(_) {}
}

// â”€â”€ Init chat: server first, localStorage fallback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function _initChat() {
  if (S.url) {
    try {
      const d = await req('GET', '/api/chat/history');
      if (d.updated_at && Array.isArray(d.messages) && d.messages.length > 0) {
        S.historyUpdatedAt = d.updated_at;
        S.chat = d.messages;
        localStorage.setItem('chatHistory', JSON.stringify(S.chat));
        const box = document.getElementById('chatBox');
        box.innerHTML = '';
        S.chat.forEach(m => addMsg(m.role, m.content));
        return;
      }
    } catch(_) {}
  }
  // Fallback: localStorage
  const saved = localStorage.getItem('chatHistory');
  if (saved) {
    try {
      const hist = JSON.parse(saved);
      if (Array.isArray(hist) && hist.length > 0) {
        S.chat = hist;
        const box = document.getElementById('chatBox');
        box.innerHTML = '';
        hist.forEach(m => addMsg(m.role, m.content));
        return;
      }
    } catch(_) {}
  }
  // No history anywhere â€” show welcome
  _addWelcomeMsg();
}

function _addWelcomeMsg() {
  addMsg('assistant', "Hi! I'm Claude, connected to your Japan 225 bot. I can read files, fix bugs, check logs, and push changes to GitHub. What do you need?");
}

function clearChat() {
  S.chat = [];
  S.historyUpdatedAt = '';
  localStorage.removeItem('chatHistory');
  if (S.url) req('POST', '/api/chat/history', { messages: [] }).catch(() => {});
  const box = document.getElementById('chatBox');
  box.innerHTML = '';
  _addWelcomeMsg();
}

// â”€â”€ Chat cost badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function _refreshChatCost() {
  if (!S.url) return;
  try {
    const [chatD, statusD] = await Promise.all([
      req('GET', '/api/chat/costs').catch(() => ({})),
      req('GET', '/api/status').catch(() => ({})),
    ]);
    const badge = document.getElementById('chatCostBadge');
    if (!badge) return;
    const chatTk = chatD.today_tokens ? `Chat ~${(chatD.today_tokens/1000).toFixed(1)}k` : '';
    const botTk  = statusD.tokens_today ? `Bot ~${(statusD.tokens_today.tokens/1000).toFixed(1)}k` : '';
    const parts = [chatTk, botTk].filter(Boolean);
    badge.textContent = parts.length ? parts.join(' | ') + ' tokens today' : '$0 (subscription)';
  } catch(_) {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doControl(action) {
  const info = {
    'force-scan': ['Force scan now?', 'Triggers an immediate market scan outside the normal interval.'],
    'restart':    ['Restart the bot?', 'Monitor service will restart. Warning shown if position is open.'],
    'stop':       ['Stop the bot?', 'Monitor service will stop. No scanning or monitoring until manually restarted.'],
  };
  if (!await confirm2(...info[action])) return;
  try {
    const d = await req('POST', '/api/controls/' + action);
    alert2('ctrlAlert', d.warning ? 'warn' : 'ok', (d.warning ? 'âš  ' : 'âœ“ ') + (d.warning || d.message || 'Done'));
  } catch(e) { alert2('ctrlAlert', 'err', 'âœ— ' + e.message); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETTINGS MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSettings() {
  document.getElementById('sUrl').value   = S.url;
  document.getElementById('sToken').value = S.token;
  document.getElementById('settingsOverlay').classList.remove('hidden');
}
function closeSettings() { document.getElementById('settingsOverlay').classList.add('hidden'); }

async function saveSettings() {
  const url   = document.getElementById('sUrl').value.trim().replace(/\/+$/, '');
  const token = document.getElementById('sToken').value.trim();
  if (!url) { alert2('sAlert','err','URL is required'); return; }
  try {
    const r = await fetch(url + '/api/health', { headers:{'Authorization':'Bearer '+token,'ngrok-skip-browser-warning':'true'} });
    if (!r.ok) throw new Error('HTTP ' + r.status);
  } catch(e) { alert2('sAlert','err','Cannot connect: ' + e.message); return; }
  S.url = url; S.token = token;
  localStorage.setItem('apiUrl', url);
  localStorage.setItem('apiToken', token);
  closeSettings();
  setConn('ok','Connected');
  loadOverview();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIRM MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _res = null;
function confirm2(title, desc) {
  return new Promise(r => {
    _res = r;
    document.getElementById('confTitle').textContent = title;
    document.getElementById('confDesc').textContent  = desc;
    document.getElementById('confOk').onclick = () => { closeConfirm(true); };
    document.getElementById('confirmOverlay').classList.remove('hidden');
  });
}
function closeConfirm(v) {
  document.getElementById('confirmOverlay').classList.add('hidden');
  if (_res) { _res(v); _res = null; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function alert2(id, type, msg) {
  const el = document.getElementById(id);
  if (!el) return;
  el.className = 'alert a-' + type;
  el.textContent = msg;
  clearTimeout(el._t);
  el._t = setTimeout(() => el.classList.add('hidden'), 5000);
}
function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function fmt1(v) { return v != null ? Number(v).toFixed(1) : 'â€”'; }
function _utc(iso) { return iso && !iso.endsWith('Z') && !iso.includes('+') ? iso + 'Z' : iso; }
function ago(iso) {
  const s = Math.floor((Date.now() - new Date(_utc(iso))) / 1000);
  if (s < 60) return s + 's ago';
  if (s < 3600) return Math.floor(s/60) + 'm ago';
  return Math.floor(s/3600) + 'h ago';
}
function fmtTime(iso) { return iso ? new Date(_utc(iso)).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : 'â€”'; }
function fmtCountdown(secs) {
  if (secs == null || secs < 0) return 'â€”';
  const s = Math.round(secs);
  if (s <= 0) return '0s';
  const m = Math.floor(s / 60), r = s % 60;
  return m > 0 ? `${m}m ${r.toString().padStart(2,'0')}s` : `${r}s`;
}

// Live countdown ticker â€” updated every second, seeded by API value
let _cdSecs = null, _cdAt = null, _lastScanIso = null;
function _seedCountdown(secs, lastScanIso) {
  _cdSecs      = secs != null ? secs : null;
  _cdAt        = secs != null ? Date.now() : null;
  _lastScanIso = lastScanIso || null;
}
function _tickCountdown() {
  const nextEl = document.getElementById('nextScanVal');
  if (nextEl && _cdSecs != null) {
    const elapsed   = (Date.now() - _cdAt) / 1000;
    const remaining = Math.max(0, _cdSecs - elapsed);
    nextEl.textContent = fmtCountdown(remaining);
  }
  const lastEl = document.getElementById('lastScanVal');
  if (lastEl && _lastScanIso) {
    lastEl.textContent = ago(_lastScanIso);
  }
}
function fmtDt(iso) {
  if (!iso) return 'â€”';
  const d = new Date(_utc(iso));
  return d.toLocaleDateString([],{month:'short',day:'numeric'}) + ' ' +
         d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function init() {
  document.getElementById('lTabScan').style.color = 'var(--primary)';
  if (!S.url) {
    showNotConfigured();   // shows "Click âš™ to configure" â€” no modal, no blocking overlay
  } else {
    loadOverview();
  }
  _initChat();                                                         // server-first, localStorage fallback
  _refreshChatCost();                                                  // show cost badge immediately
  // Recover any job that was in-flight when page was refreshed
  const _savedJob = localStorage.getItem('pendingJob');
  if (_savedJob) {
    try {
      const { job_id } = JSON.parse(_savedJob);
      if (job_id) {
        const thinkEl = _addThinkingBubble();
        _startJobPolling(job_id, thinkEl);
      }
    } catch(_) { localStorage.removeItem('pendingJob'); }
  }
  setInterval(() => { if (S.tab === 'overview' && S.url) loadOverview(); }, 15000);  // overview auto-refresh
  setInterval(_tickCountdown, 1000);                                   // live countdown ticker
  setInterval(_pollHistory, 5000);                                     // cross-device chat sync
  setInterval(_refreshChatCost, 30000);                               // chat cost badge refresh
})();
</script>
</body>
</html>
